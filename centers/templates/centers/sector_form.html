{% extends 'centers/base.html' %}

{% load org_tags %}
{% load static %}

{% block title %}
  {% if sector %}
    {{ sector.name }} - Editar
  {% else %}
    {{ company.name }} - Novo Setor
  {% endif %}
{% endblock %}

{% block breadcrumb %}
  <i class="right chevron icon divider"></i>
  <a class="section" href="{% url 'centers:center_list' organization.slug company.slug %}">
    <h2 class="ui inverted header">Centros de Custo</h2>
  </a>
  <i class="right chevron icon divider"></i>
  <a class="section" href="{% url 'centers:sector_list' organization.slug company.slug %}">
    <h2 class="ui inverted header">Setores</h2>
  </a>
  {% if sector %}
    <i class="right chevron icon divider"></i>
    <a class="section">
      <h2 class="ui inverted header">Editar</h2>
    </a>
  {% else %}
    <i class="right chevron icon divider"></i>
    <a class="section">
      <h2 class="ui inverted header">Novo</h2>
    </a>
  {% endif %}
{% endblock %}

{% block center-content %}
<div class="ui container">
  {% include "utils/form-error-messages.html" %}

  <form class="ui form" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <h4 class="ui dividing header">Setor</h4>
    <div class="two fields">
      {% if form.center %}
        {% include "utils/form-field.html" with field=form.center %}
      {% endif %}
      {% include "utils/form-field.html" with field=form.name %}
    </div>

    <h4 class="ui dividing header">Associar Ramais</h4>
    <div id="center-extension">
      {% if sector %}
        {% if available_ext_range %}
          <div class="ui info message">
            RAMAIS DISPONÍVEIS: {{ available_ext_range }}
          </div>
        {% else %}
          <div class="ui negative message">
            RAMAIS DISPONÍVEIS: Não há ramais disponíveis! Solicite novos ramais.
          </div>
        {% endif %}
      {% endif %}
    </div>
    {% include "utils/form-field.html" with field=form.extension_range %}

    <button class="ui blue button" type="submit">Salvar</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(() => {
    $('.ui.dropdown').dropdown()

    $("#id_center").change(function() {
      var url = "/{{ organization.slug }}/companies/{{ company.slug }}/sectors"
      var centerPk = $(this).val()

      $.ajax({
        url: `${url}/${centerPk}/detail/`,
        success: function ({ available_ext_range }) {
          if (available_ext_range) {
            $("#center-extension").html(`
              <div class="ui info message">
                RAMAIS DISPONÍVEIS: ${ available_ext_range }
              </div>
            `)
          } else {
            $("#center-extension").html(`
              <div class="ui negative message">
                RAMAIS DISPONÍVEIS: Não há ramais disponíveis! Atualize os ramais do centro de custo.
              </div>
            `)
          }
        }
      })
    })
  })
</script>
{% endblock %}